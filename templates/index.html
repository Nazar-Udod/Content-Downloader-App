{% extends "layout.html" %}

{% block title %}Завантажувач контенту{% endblock %}

{% block content %}
    
    {% if convert_error %}
        <div class="error">
            <strong>Помилка конвертації:</strong> {{ convert_error }}
        </div>
    {% endif %}

    <h1>Завантажувач контенту</h1>
    <p>Введіть пошуковий запит, щоб знайти статті, відео або музику.</p>

    <form class="search-form" action="/search" method="post">
        <input type="text" name="query" placeholder="Наприклад, 'Історія FastAPI'" value="{{ query or '' }}" required>
        <button type="submit">Пошук</button>
    </form>

    {% if error %}
        <div class="error">{{ error }}</div>
    {% endif %}

    {% if query and not results and not error %}
        <div class="info">Нічого не знайдено за запитом "{{ query }}". Спробуйте інший.</div>
    {% endif %}
    {% if results %}
        <h2>Результати пошуку для "{{ query }}"</h2>

        <form id="results-form" method="post">
            <div class="results-container">

            {% for result in results %}
                <div class="result-item">

                    <h3>
                        <a href="{{ result.link }}" target="_blank" rel="noopener noreferrer">{{ result.title }}</a>
                    </h3>
                    <p class="link">{{ result.link }}</p>
                    <p>{{ result.snippet }}</p>

                    <div class="actions">
                        {% set item_url = result.link %}
                        {% set item_type = result.type %}

                        {% if item_type == 'text' %}
                            <button type="submit"
                                    formaction="/convert"
                                    formmethod="post"
                                    name="convert_index"
                                    value="{{ loop.index0 }}">
                                Конвертувати в PDF
                            </button>
                            <span class="tag text">Web-сторінка</span>

                        {% elif item_type == 'video' %}
                            <button type="submit"
                                    formaction="/history/track-click"
                                    formmethod="post"
                                    name="track_index"
                                    value="{{ loop.index0 }}"
                                    class="link-button"
                                    formtarget="_blank">
                                Перейти на YouTube
                            </button>
                            <span class="tag video">Відео</span>
                        {% elif item_type == 'pdf' %}
                            <button type="submit" formaction="/history/track-click" formmethod="post"
                                    name="track_index" value="{{ loop.index0 }}"
                                    class="link-button" formtarget="_blank" download>
                                Завантажити PDF
                            </button>
                            <span class="tag pdf">PDF Документ</span>
                        {% elif item_type == 'doc' %}
                            <button type="submit" formaction="/history/track-click" formmethod="post"
                                    name="track_index" value="{{ loop.index0 }}"
                                    class="link-button" formtarget="_blank" download>
                                Завантажити DOC
                            </button>
                            <span class="tag doc">DOC Документ</span>
                        {% elif item_type == 'ppt' %}
                            <button type="submit" formaction="/history/track-click" formmethod="post"
                                    name="track_index" value="{{ loop.index0 }}"
                                    class="link-button" formtarget="_blank" download>
                                Завантажити PPT
                            </button>
                            <span class="tag ppt">Презентація</span>
                        {% elif item_type == 'audio_yt_music' %}
                            <button type="submit" formaction="/history/track-click" formmethod="post"
                                    name="track_index" value="{{ loop.index0 }}"
                                    class="link-button" formtarget="_blank">
                                Слухати в YouTube Music
                            </button>
                            <span class="tag audio">Аудіо</span>
                        {% elif item_type == 'audio_spotify' %}
                            <button type="submit" formaction="/history/track-click" formmethod="post"
                                    name="track_index" value="{{ loop.index0 }}"
                                    class="link-button" formtarget="_blank">
                                Слухати в Spotify
                            </button>
                            <span class="tag audio">Аудіо</span>
                        {% endif %}
                    </div>
                    {% if user_email and folders %}
                    <div class="bookmark-form">
                        <input type="hidden" name="url_{{ loop.index0 }}" value="{{ result.link }}">
                        <input type="hidden" name="type_{{ loop.index0 }}" value="{{ result.type }}">

                        <label for="bm-name-{{ loop.index0 }}" style="display: none;">Назва:</label>
                        <input type="text" name="name_{{ loop.index0 }}" id="bm-name-{{ loop.index0 }}"
                               value="{{ result.title }}" required
                               title="Назва закладки">

                        <label for="bm-folder-{{ loop.index0 }}" style="display: none;">Папка:</label>
                        <select name="folder_id_{{ loop.index0 }}" id="bm-folder-{{ loop.index0 }}" title="Обрати папку">
                            {% for folder in folders %}
                            <option value="{{ folder.FolderID }}">{{ folder.Name }}</option>
                            {% endfor %}
                        </select>

                        <button type="submit"
                                name="bookmark_index"
                                value="{{ loop.index0 }}"
                                formaction="/bookmarks/add"
                                formmethod="post">
                            Додати в закладки
                        </button>
                    </div>
                    {% endif %}
                    <div class="selection-controls">
                        <label>
                            <input type="checkbox" name="selected_indices" value="{{ loop.index0 }}">
                            Обрати для оптимізації
                        </label>
                        <label>
                            Вага (1-10):
                            <input type="number" name="weight_{{ loop.index0 }}" min="1" max="10" value="5">
                        </label>

                        <input type="hidden" name="title_{{ loop.index0 }}" value="{{ result.title }}">
                        <input type="hidden" name="link_{{ loop.index0 }}" value="{{ result.link }}">
                        <input type="hidden" name="snippet_{{ loop.index0 }}" value="{{ result.snippet | escape }}">
                        <input type="hidden" name="type_{{ loop.index0 }}" value="{{ result.type }}">
                    </div>
                </div>
            {% endfor %}
            </div>

            <button type="submit" formaction="/add-to-list" class="add-button">
                Додати обрані до списку оптимізації
            </button>
        </form>

    {% endif %}
{% endblock %}