{% extends "layout.html" %}

{% block title %}Оптимізація контенту{% endblock %}

{% block content %}
    <div class="page-nav">
        <a href="/">← Повернутися до пошуку</a>
    </div>

    <h1>Налаштування оптимізації</h1>

    {% if error %}
        <div class="error">{{ error }}</div>
    {% endif %}

    {% if not items %}
        <div class="info">Ваш список для оптимізації порожній.</div>
    {% endif %}

    {% if items %}

    <form action="/fetch-sizes" method="post">
        <button type="submit" class="fetch-button">
            Отримати / Оновити розміри
        </button>
    </form>

    <form class="config-form" action="/optimize" method="post">

        <h2>1. Перевірте ваги та розміри</h2>

        {% if total_size > 0 %}
        <div class="total-size-bar">
            Загальний розмір обраних: {{ total_size }} MB
        </div>
        {% endif %}

        {% for item in items %}
        <div class="result-item">
            <h3>
                {{ item.title }}
            </h3>
            <p class="link">{{ item.link }}</p>

            <div class="optimization-item-params">
                <label>
                    Вага (пріоритет):
                    <input type="number" name="weight_{{ loop.index0 }}" class="weight-input" min="1" max="10" value="{{ item.weight }}">
                </label>

                {% if item.size_mb is not none %}
                    <span class="size-info {% if item.is_estimated %}estimated{% endif %}">
                        Розмір: {{ item.size_mb }} MB
                        {% if item.is_estimated %}(Оцінка){% endif %}
                    </span>
                {% else %}
                    <span class="size-info unknown">
                        Розмір невідомий
                    </span>
                {% endif %}
            </div>

            <input type="hidden" name="title_{{ loop.index0 }}" value="{{ item.title }}">
            <input type="hidden" name="link_{{ loop.index0 }}" value="{{ item.link }}">
            <input type="hidden" name="snippet_{{ loop.index0 }}" value="{{ item.snippet | escape }}">
            <input type="hidden" name="type_{{ loop.index0 }}" value="{{ item.type }}">
            <input type="hidden" name="size_mb_{{ loop.index0 }}" value="{{ item.size_mb or 0.0 }}">
            <input type="hidden" name="is_estimated_{{ loop.index0 }}" value="{{ item.is_estimated }}">
            <input type="hidden" name="cache_file_{{ loop.index0 }}" value="{{ item.cache_file or '' }}">
        </div>
        {% endfor %}

        <input type="hidden" name="item_count" value="{{ items | length }}">
        <hr style="margin: 25px 0;">

        <h2>2. Вкажіть загальний об'єм</h2>
        <label for="memory_size">Доступний об'єм пам'яті (MB):</label>
        <input type="number" id="memory_size" name="memory_size" min="1" value="{{ memory_size or '1000' }}">

        <button type="submit">Оптимізувати!</button>
    </form>
    {% endif %}

    {% if optimized_results %}
    <div class="optimization-results">
        <h2>Оптимальний набір</h2>
        <p>Ліміт: {{ memory_size }} MB.</p>
        <button type="button" onclick="downloadAllOptimized()" class="fetch-button">
            Завантажити все
        </button>
        {% for result in optimized_results %}
            <div class="result-item">
                <h3>
                    <a href="{{ result.link }}" target="_blank" rel="noopener noreferrer">{{ result.title }}</a>
                </h3>
                <p class="link">{{ result.link }}</p>

                <div class="optimization-result-params">
                    <span>Вага: {{ result.weight }}</span>
                    <span>Розмір: {{ result.size_mb }} MB {% if result.is_estimated %}(Оцінка){% endif %}</span>
                </div>

                <div class="actions">
                    {% set item_url = result.link %}
                    {% set item_type = result.type %}

                    {% if item_type == 'text' %}
                        <form action="/convert" method="post" class="convert-form">
                            <input type="hidden" name="url" value="{{ item_url | escape }}">
                            <input type="hidden" name="type" value="text">
                            <button type="submit">Конвертувати в PDF</button>
                        </form>
                        <span class="tag text">Web-сторінка</span>

                    {% elif item_type == 'video' %}
                        <form action="/history/track-click" method="post" class="convert-form" target="_blank">
                            <input type="hidden" name="url" value="{{ item_url | escape }}">
                            <input type="hidden" name="type" value="{{ item_type }}">
                            <button type="submit" class="link-button">Перейти на YouTube</button>
                        </form>
                        <span class="tag video">Відео</span>

                    {% elif item_type == 'pdf' %}
                        <form action="/history/track-click" method="post" class="convert-form" target="_blank">
                            <input type="hidden" name="url" value="{{ item_url | escape }}">
                            <input type="hidden" name="type" value="{{ item_type }}">
                            <button type="submit" class="link-button" download>Завантажити PDF</button>
                        </form>
                        <span class="tag pdf">PDF Документ</span>

                    {% elif item_type == 'doc' %}
                        <form action="/history/track-click" method="post" class="convert-form" target="_blank">
                            <input type="hidden" name="url" value="{{ item_url | escape }}">
                            <input type="hidden" name="type" value="{{ item_type }}">
                            <button type="submit" class="link-button" download>Завантажити DOC</button>
                        </form>
                        <span class="tag doc">DOC Документ</span>

                    {% elif item_type == 'ppt' %}
                        <form action="/history/track-click" method="post" class="convert-form" target="_blank">
                            <input type="hidden" name="url" value="{{ item_url | escape }}">
                            <input type="hidden" name="type" value="{{ item_type }}">
                            <button type="submit" class="link-button" download>Завантажити PPT</button>
                        </form>
                        <span class="tag ppt">Презентація</span>

                    {% elif item_type == 'audio_yt_music' %}
                        <form action="/history/track-click" method="post" class="convert-form" target="_blank">
                            <input type="hidden" name="url" value="{{ item_url | escape }}">
                            <input type="hidden" name="type" value="{{ item_type }}">
                            <button type="submit" class="link-button">Слухати в YouTube Music</button>
                        </form>
                        <span class="tag audio">Аудіо</span>

                    {% elif item_type == 'audio_spotify' %}
                        <form action="/history/track-click" method="post" class="convert-form" target="_blank">
                            <input type="hidden" name="url" value="{{ item_url | escape }}">
                            <input type="hidden" name="type" value="{{ item_type }}">
                            <button type="submit" class="link-button">Слухати в Spotify</button>
                        </form>
                        <span class="tag audio">Аудіо</span>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>
    {% endif %}

{% endblock %}