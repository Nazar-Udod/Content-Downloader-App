{% extends "layout.html" %}

{% block title %}Завантажувач контенту{% endblock %}

{% block head_styles %}
<style>
    .search-form {
        display: flex; gap: 10px; margin-bottom: 30px;
    }
    .search-form input[type="text"] {
        flex-grow: 1; padding: 12px 15px; border: 1px solid #ddd;
        border-radius: 8px; font-size: 16px;
    }
    .search-form button {
        padding: 12px 20px; background-color: #3498db; color: white;
        border: none; border-radius: 8px; cursor: pointer; font-size: 16px;
    }
    .results-container { margin-top: 20px; }
    .result-item {
        background-color: #fdfdfd; border: 1px solid #eef; padding: 20px;
        border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    .result-item h3 { margin-top: 0; color: #2980b9; }
    .result-item a { color: #2980b9; text-decoration: none; }
    .result-item p { margin-bottom: 15px; }
    .result-item .link { font-size: 0.9em; color: #555; word-break: break-all; }
    .actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .actions button, .actions a {
        padding: 8px 15px; border-radius: 6px; text-decoration: none;
        color: white; font-size: 14px; cursor: pointer;
    }
    .actions button { background-color: #27ae60; border: none; }
    .actions a { background-color: #e67e22; }
    .tag { display: inline-block; padding: 3px 8px; border-radius: 5px; font-size: 12px; color: white; margin-left: 10px; }
    .tag.text { background-color: #3498db; }
    .tag.video { background-color: #c0392b; }
    .tag.audio { background-color: #8e44ad; }
    .tag.pdf { background-color: #e74c3c; }
    .tag.doc { background-color: #2980b9; }
    .tag.ppt { background-color: #d35400; }
    
    .selection-controls {
        background-color: #f8f9fa; border: 1px solid #e0e6ed; padding: 15px;
        border-radius: 8px; margin-top: 15px; display: flex;
        gap: 20px; align-items: center;
    }
    .selection-controls label { font-weight: 500; display: flex; align-items: center; gap: 8px; }
    .selection-controls input[type="number"] { width: 60px; padding: 5px 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; }
    .selection-controls input[type="checkbox"] { transform: scale(1.3); }

    .add-button {
        display: block; width: 100%; padding: 15px; font-size: 18px; font-weight: 600;
        color: white; background-color: #3498db; border: none;
        border-radius: 8px; cursor: pointer; margin-top: 30px; transition: background-color 0.3s;
    }
    .add-button:hover { background-color: #2980b9; }

    .bookmark-form {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px dashed #e0e6ed;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }
    .bookmark-form input[type="text"] {
        flex: 1 1 200px;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 14px;
    }
    .bookmark-form select {
        flex: 1 1 150px;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 14px;
        background-color: #fff;
    }
    .bookmark-form button {
        flex: 0 0 auto;
        padding: 8px 15px;
        font-size: 14px;
        font-weight: 500;
        background-color: #5d6d7e;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    .link-button {
        background-color: #e67e22; padding: 8px 15px; border-radius: 6px;
        color: white; font-size: 14px; cursor: pointer; border: none;
        font-family: inherit;
    }
</style>
{% endblock %}

{% block content %}
    
    {% if convert_error %}
        <div class="error" style="margin-top: 0;">
            <strong>Помилка конвертації:</strong> {{ convert_error }}
        </div>
    {% endif %}

    <h1>Завантажувач контенту</h1>
    <p>Введіть пошуковий запит, щоб знайти статті, відео або музику.</p>

    <form class="search-form" action="/search" method="post">
        <input type="text" name="query" placeholder="Наприклад, 'Історія FastAPI'" value="{{ query or '' }}" required>
        <button type="submit">Пошук</button>
    </form>

    {% if error %}
        <div class="error">{{ error }}</div>
    {% endif %}

    {% if query and not results and not error %}
        <div class="info">Нічого не знайдено за запитом "{{ query }}". Спробуйте інший.</div>
    {% endif %}
    {% if results %}
        <h2>Результати пошуку для "{{ query }}"</h2>

        <form id="results-form" method="post">
            <div class="results-container">

            {% for result in results %}
                <div class="result-item">

                    <h3>
                        <a href="{{ result.link }}" target="_blank" rel="noopener noreferrer">{{ result.title }}</a>
                    </h3>
                    <p class="link">{{ result.link }}</p>
                    <p>{{ result.snippet }}</p>

                    <div class="actions">
                        {% set item_url = result.link %}
                        {% set item_type = result.type %}

                        {% if item_type == 'text' %}
                            <button type="submit"
                                    formaction="/convert"
                                    formmethod="post"
                                    name="convert_index"
                                    value="{{ loop.index0 }}">
                                Конвертувати в PDF
                            </button>
                            <span class="tag text">Web-сторінка</span>

                        {% elif item_type == 'video' %}
                            <button type="submit"
                                    formaction="/history/track-click"
                                    formmethod="post"
                                    name="track_index"
                                    value="{{ loop.index0 }}"
                                    class="link-button"
                                    formtarget="_blank">
                                Перейти на YouTube
                            </button>
                            <span class="tag video">Відео</span>
                        {% elif item_type == 'pdf' %}
                            <button type="submit" formaction="/history/track-click" formmethod="post"
                                    name="track_index" value="{{ loop.index0 }}"
                                    class="link-button" formtarget="_blank" download>
                                Завантажити PDF
                            </button>
                            <span class="tag pdf">PDF Документ</span>
                        {% elif item_type == 'doc' %}
                            <button type="submit" formaction="/history/track-click" formmethod="post"
                                    name="track_index" value="{{ loop.index0 }}"
                                    class="link-button" formtarget="_blank" download>
                                Завантажити DOC
                            </button>
                            <span class="tag doc">DOC Документ</span>
                        {% elif item_type == 'ppt' %}
                            <button type="submit" formaction="/history/track-click" formmethod="post"
                                    name="track_index" value="{{ loop.index0 }}"
                                    class="link-button" formtarget="_blank" download>
                                Завантажити PPT
                            </button>
                            <span class="tag ppt">Презентація</span>
                        {% elif item_type == 'audio_yt_music' %}
                            <button type="submit" formaction="/history/track-click" formmethod="post"
                                    name="track_index" value="{{ loop.index0 }}"
                                    class="link-button" formtarget="_blank">
                                Слухати в YouTube Music
                            </button>
                            <span class="tag audio">Аудіо</span>
                        {% elif item_type == 'audio_spotify' %}
                            <button type="submit" formaction="/history/track-click" formmethod="post"
                                    name="track_index" value="{{ loop.index0 }}"
                                    class="link-button" formtarget="_blank">
                                Слухати в Spotify
                            </button>
                            <span class="tag audio">Аудіо</span>
                        {% endif %}
                    </div>
                    {% if user_email and folders %}
                    <div class="bookmark-form">
                        <input type="hidden" name="url_{{ loop.index0 }}" value="{{ result.link }}">
                        <input type="hidden" name="type_{{ loop.index0 }}" value="{{ result.type }}">

                        <label for="bm-name-{{ loop.index0 }}" style="display: none;">Назва:</label>
                        <input type="text" name="name_{{ loop.index0 }}" id="bm-name-{{ loop.index0 }}"
                               value="{{ result.title }}" required
                               title="Назва закладки">

                        <label for="bm-folder-{{ loop.index0 }}" style="display: none;">Папка:</label>
                        <select name="folder_id_{{ loop.index0 }}" id="bm-folder-{{ loop.index0 }}" title="Обрати папку">
                            {% for folder in folders %}
                            <option value="{{ folder.FolderID }}">{{ folder.Name }}</option>
                            {% endfor %}
                        </select>

                        <button type="submit"
                                name="bookmark_index"
                                value="{{ loop.index0 }}"
                                formaction="/bookmarks/add"
                                formmethod="post">
                            Додати в закладки
                        </button>
                    </div>
                    {% endif %}
                    <div class="selection-controls">
                        <label>
                            <input type="checkbox" name="selected_indices" value="{{ loop.index0 }}">
                            Обрати для оптимізації
                        </label>
                        <label>
                            Вага (1-10):
                            <input type="number" name="weight_{{ loop.index0 }}" min="1" max="10" value="5">
                        </label>

                        <input type="hidden" name="title_{{ loop.index0 }}" value="{{ result.title }}">
                        <input type="hidden" name="link_{{ loop.index0 }}" value="{{ result.link }}">
                        <input type="hidden" name="snippet_{{ loop.index0 }}" value="{{ result.snippet | escape }}">
                        <input type="hidden" name="type_{{ loop.index0 }}" value="{{ result.type }}">
                    </div>
                </div>
            {% endfor %}
            </div>

            <button type="submit" formaction="/add-to-list" class="add-button">
                Додати обрані до списку
            </button>
        </form>

    {% endif %}
{% endblock %}