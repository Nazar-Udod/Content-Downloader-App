{% extends "layout.html" %}

{% block title %}Оптимізація контенту{% endblock %}

{% block content %}
    <div class="page-nav">
        <a href="/">← Повернутися до пошуку</a>
    </div>

    <h1>Налаштування оптимізації</h1>

    {% if error %}
        <div class="error">{{ error }}</div>
    {% endif %}

    {% if not items %}
        <div class="info">Ваш список для оптимізації порожній.</div>
    {% endif %}

    {% if items %}

    <form action="/fetch-sizes" method="post">
        <button type="submit" class="fetch-button">
            Отримати / Оновити розміри
        </button>
    </form>

    <form class="config-form" action="/optimize" method="post">

        <h2>1. Перевірте ваги та розміри</h2>

        {% if total_size > 0 %}
        <div class="total-size-bar">
            Загальний розмір обраних: {{ total_size }} MB
        </div>
        {% endif %}

        {% for item in items %}
        <div class="result-item">
            <h3>
                {{ item.title }}

                {% if item.type == 'text' and item.cache_file %}
                <a href="/download-pdf/{{ item.cache_file }}" class="download-pdf-btn" target="_blank">
                    Завантажити PDF
                </a>
                {% endif %}
            </h3>
            <p class="link">{{ item.link }}</p>

            <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;">
                <label>
                    Вага (пріоритет):
                    <input type="number" name="weight_{{ loop.index0 }}" class="weight-input" min="1" max="10" value="{{ item.weight }}">
                </label>

                {% if item.size_mb is not none %}
                    <span class="size-info {% if item.is_estimated %}estimated{% endif %}">
                        Розмір: {{ item.size_mb }} MB
                        {% if item.is_estimated %}(Оцінка){% endif %}
                    </span>
                {% else %}
                    <span class="size-info unknown">
                        Розмір невідомий
                    </span>
                {% endif %}
            </div>

            <input type="hidden" name="title_{{ loop.index0 }}" value="{{ item.title }}">
            <input type="hidden" name="link_{{ loop.index0 }}" value="{{ item.link }}">
            <input type="hidden" name="snippet_{{ loop.index0 }}" value="{{ item.snippet | escape }}">
            <input type="hidden" name="type_{{ loop.index0 }}" value="{{ item.type }}">
            <input type="hidden" name="size_mb_{{ loop.index0 }}" value="{{ item.size_mb or 0.0 }}">
            <input type="hidden" name="is_estimated_{{ loop.index0 }}" value="{{ item.is_estimated }}">
            <input type="hidden" name="cache_file_{{ loop.index0 }}" value="{{ item.cache_file or '' }}">
        </div>
        {% endfor %}

        <input type="hidden" name="item_count" value="{{ items | length }}">
        <hr style="margin: 25px 0;">

        <h2>2. Вкажіть загальний об'єм</h2>
        <label for="memory_size">Доступний об'єм пам'яті (MB):</label>
        <input type="number" id="memory_size" name="memory_size" min="1" value="{{ memory_size or '1000' }}">

        <button type="submit">Оптимізувати!</button>
    </form>
    {% endif %}

    {% if optimized_results %}
    <div class="optimization-results">
        <h2>Оптимальний набір</h2>
        <p>Ліміт: {{ memory_size }} MB.</p>
        <button type="button" onclick="downloadAllOptimized()" class="fetch-button"
                style="background-color: #27ae60; margin-bottom: 25px;">
            Завантажити все
        </button>
        {% for result in optimized_results %}
            {% set download_url = '' %}
            {% if result.type == 'text' and result.cache_file %}
                {% set download_url = '/download-pdf/' ~ result.cache_file %}
            {% elif result.type in ['pdf', 'doc', 'docx', 'ppt', 'pptx'] %}
                {% set download_url = result.link %}
            {% endif %}
            <div class="result-item"
                 {% if download_url %}
                     data-download-url="{{ download_url }}"
                 {% endif %}
            >
                <h3>
                    <a href="{{ result.link }}" target="_blank" rel="noopener noreferrer">{{ result.title }}</a>
                    {% if result.type == 'text' and result.cache_file %}
                    <a href="/download-pdf/{{ result.cache_file }}" class="download-pdf-btn" target="_blank">
                        Завантажити PDF
                    </a>
                    {% endif %}
                </h3>
                <p class="link">{{ result.link }}</p>
                <div style="display: flex; justify-content: space-between; font-weight: 600;">
                    <span>Вага: {{ result.weight }}</span>
                    <span>Розмір: {{ result.size_mb }} MB {% if result.is_estimated %}(Оцінка){% endif %}</span>
                </div>
            </div>
        {% endfor %}
    </div>
    {% endif %}

{% endblock %}